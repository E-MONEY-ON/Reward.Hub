<!-- referral.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral - RewardHub</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="page-transition-overlay"></div>
    
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-gift"></i>
            <span>RewardHub</span>
        </div>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="tasks.html">Tasks</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="referral.html" class="active">Referral</a>
            <div class="user-menu">
                <span class="user-points"><i class="fas fa-coins"></i> <span id="nav-points">0</span></span>
                <button onclick="logout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
            <i class="fas fa-bars"></i>
        </button>
    </nav>

    <main class="page-content referral-page">
        <div class="page-header">
            <h1>Refer & Earn</h1>
            <p>Invite friends and earn <span class="highlight">100 points</span> for each referral</p>
        </div>

        <div class="referral-stats-grid">
            <div class="stat-card glass gradient-purple">
                <i class="fas fa-link"></i>
                <div class="stat-details">
                    <h3>Your Referral Code</h3>
                    <div class="code-display" id="ref-code">LOADING...</div>
                </div>
            </div>
            
            <div class="stat-card glass gradient-cyan">
                <i class="fas fa-users"></i>
                <div class="stat-details">
                    <h3>Total Referrals</h3>
                    <div class="big-number" id="total-referrals">0</div>
                </div>
            </div>
            
            <div class="stat-card glass gradient-pink">
                <i class="fas fa-coins"></i>
                <div class="stat-details">
                    <h3>Earned from Referrals</h3>
                    <div class="big-number" id="ref-earnings">0</div>
                </div>
            </div>
        </div>

        <div class="referral-link-section glass">
            <h2><i class="fas fa-share-alt"></i> Share Your Link</h2>
            <div class="link-box">
                <input type="text" id="ref-link" readonly value="Generating...">
                <button onclick="copyLink()" class="btn-glow">
                    <i class="fas fa-copy"></i>
                    <span>Copy</span>
                </button>
            </div>
            <div class="share-buttons">
                <button onclick="shareSocial('twitter')" class="share-btn twitter">
                    <i class="fab fa-twitter"></i>
                </button>
                <button onclick="shareSocial('facebook')" class="share-btn facebook">
                    <i class="fab fa-facebook-f"></i>
                </button>
                <button onclick="shareSocial('whatsapp')" class="share-btn whatsapp">
                    <i class="fab fa-whatsapp"></i>
                </button>
                <button onclick="shareSocial('telegram')" class="share-btn telegram">
                    <i class="fab fa-telegram-plane"></i>
                </button>
            </div>
        </div>

        <div class="referral-list glass">
            <h3><i class="fas fa-list"></i> Your Referrals</h3>
            <div class="referrals-table-container">
                <table class="referrals-table" id="referrals-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Date Joined</th>
                            <th>Your Reward</th>
                        </tr>
                    </thead>
                    <tbody id="referrals-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
                <div class="empty-state hidden" id="no-referrals">
                    <i class="fas fa-user-friends"></i>
                    <p>No referrals yet. Share your link to start earning!</p>
                </div>
            </div>
        </div>

        <div class="referral-tips glass">
            <h3><i class="fas fa-lightbulb"></i> Tips to Get More Referrals</h3>
            <ul>
                <li><i class="fas fa-check"></i> Share on social media platforms</li>
                <li><i class="fas fa-check"></i> Tell friends about the earning potential</li>
                <li><i class="fas fa-check"></i> Post in relevant online communities</li>
                <li><i class="fas fa-check"></i> Create a YouTube review or tutorial</li>
            </ul>
        </div>
    </main>

    <div id="toast-container"></div>
    <canvas id="confetti-canvas"></canvas>

    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadReferralData();
        });

        function loadReferralData() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const currentUserData = users.find(u => u.id === user.id);
            
            // Update code and link
            const refCode = currentUserData.referralCode;
            const refLink = `${window.location.origin}/register.html?ref=${refCode}`;
            
            document.getElementById('ref-code').textContent = refCode;
            document.getElementById('ref-link').value = refLink;
            
            // Stats
            const referrals = currentUserData.referrals || [];
            document.getElementById('total-referrals').textContent = referrals.length;
            document.getElementById('ref-earnings').textContent = (referrals.length * 100).toLocaleString();
            document.getElementById('nav-points').textContent = user.points;
            
            // Load referral details
            loadReferralDetails(referrals, users);
        }

        function loadReferralDetails(referralIds, allUsers) {
            const tbody = document.getElementById('referrals-body');
            const emptyState = document.getElementById('no-referrals');
            
            if (referralIds.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            const referrals = referralIds.map(id => allUsers.find(u => u.id === id)).filter(Boolean);
            
            tbody.innerHTML = referrals.map(ref => `
                <tr>
                    <td>
                        <div class="user-cell">
                            <div class="user-avatar">${ref.name.charAt(0).toUpperCase()}</div>
                            <span>${ref.name}</span>
                        </div>
                    </td>
                    <td>${new Date(ref.joinedAt).toLocaleDateString()}</td>
                    <td><span class="points-badge">+100 pts</span></td>
                </tr>
            `).join('');
        }

        function copyLink() {
            const link = document.getElementById('ref-link');
            link.select();
            document.execCommand('copy');
            
            showToast('Link copied to clipboard!', 'success');
            
            // Visual feedback
            const btn = document.querySelector('.link-box .btn-glow');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i><span>Copied!</span>';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
            }, 2000);
        }

        function shareSocial(platform) {
            const link = encodeURIComponent(document.getElementById('ref-link').value);
            const text = encodeURIComponent('Join RewardHub and earn rewards! Use my referral link:');
            
            const urls = {
                'twitter': `https://twitter.com/intent/tweet?text=${text}&url=${link}`,
                'facebook': `https://www.facebook.com/sharer/sharer.php?u=${link}`,
                'whatsapp': `https://wa.me/?text=${text}%20${link}`,
                'telegram': `https://t.me/share/url?url=${link}&text=${text}`
            };
            
            window.open(urls[platform], '_blank', 'width=600,height=400');
        }
    </script>
</body>
</html>